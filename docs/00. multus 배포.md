## Multus 소개

## MACVLAN 소개

## IPVLAN과의 차이


## Multus 설치
해당 작업은 master 노드 또는 kubernetes cluster를 제어할 수 있는 클라이언트에서 작업한다.

Kuberenetes Cluster 정보
```
kubectl get node -owide
NAME       STATUS   ROLES                  AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
master01   Ready    control-plane,master   22h   v1.23.4   172.27.100.10    <none>        Ubuntu 20.04.2 LTS   5.4.0-65-generic   containerd://1.4.12
worker01   Ready    <none>                 22h   v1.23.4   172.27.100.101   <none>        Ubuntu 20.04.2 LTS   5.4.0-65-generic   containerd://1.4.12
worker02   Ready    <none>                 22h   v1.23.4   172.27.100.102   <none>        Ubuntu 20.04.2 LTS   5.4.0-65-generic   containerd://1.4.12

kubectl get pod -n kube-system
NAME                                       READY   STATUS    RESTARTS      AGE
calico-kube-controllers-56fcbf9d6b-nqbr8   1/1     Running   0             7m23s
calico-node-5zfxb                          1/1     Running   0             7m23s
calico-node-6klcc                          1/1     Running   0             7m23s
calico-node-gvllk                          1/1     Running   0             7m23s
coredns-64897985d-dkvpk                    1/1     Running   0             22h
coredns-64897985d-z2pjg                    1/1     Running   0             22h
haproxy-master01                           1/1     Running   1 (16m ago)   22h
kube-apiserver-master01                    1/1     Running   1 (16m ago)   22h
kube-controller-manager-master01           1/1     Running   1 (16m ago)   22h
kube-proxy-5mfv7                           1/1     Running   1 (16m ago)   22h
kube-proxy-gwvxs                           1/1     Running   1 (16m ago)   22h
kube-proxy-w8j4b                           1/1     Running   1 (16m ago)   22h
kube-scheduler-master01                    1/1     Running   1 (16m ago)   22h
```

```

git clone https://github.com/k8snetworkplumbingwg/multus-cni.git && cd multus-cni
cat ./deployments/multus-daemonset-thick-plugin.yml | kubectl apply -f -

kubectl get pod -n kube-system -l app=multus
NAME                   READY   STATUS    RESTARTS   AGE
kube-multus-ds-dnd6z   1/1     Running   0          91s
kube-multus-ds-dz789   1/1     Running   0          91s
kube-multus-ds-xsnp9   1/1     Running   0          91s

```

Daemonset으로 multus를 배포하면 /etc/cni/net.d/ 디렉터리 밑에 '00-multus.conf' 파일과 'multus.d' 디렉터리와 이 디렉터리 밑에 'multus.kubeconfig' 파일이 자동으로 생성된다.

```
sudo cat /etc/cni/net.d/00-multus.conf | jq
{
  "capabilities": {
    "bandwidth": true,
    "portMappings": true
  },
  "cniVersion": "0.3.1",
  "delegates": [
    {
      "cniVersion": "0.3.1",
      "name": "k8s-pod-network",
      "plugins": [
        {
          "datastore_type": "kubernetes",
          "ipam": {
            "type": "calico-ipam"
          },
          "kubernetes": {
            "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
          },
          "log_file_path": "/var/log/calico/cni/cni.log",
          "log_level": "info",
          "mtu": 0,
          "nodename": "master01",
          "policy": {
            "type": "k8s"
          },
          "type": "calico"
        },
        {
          "capabilities": {
            "portMappings": true
          },
          "snat": true,
          "type": "portmap"
        },
        {
          "capabilities": {
            "bandwidth": true
          },
          "type": "bandwidth"
        }
      ]
    }
  ],
  "logLevel": "verbose",
  "logToStderr": true,
  "kubeconfig": "/etc/cni/net.d/multus.d/multus.kubeconfig",
  "name": "multus-cni-network",
  "type": "multus"
}

```

이제 multus를 배포했으니, pod에 추가적으로 연결 될 NIC(Network Interface Card)를 정의한다.

위 multus 배포 과정에서 multus 관련 CRD(Custom Resource Define)가 생성 된다.

```
kubectl get crd network-attachment-definitions.k8s.cni.cncf.io
NAME                                             CREATED AT
network-attachment-definitions.k8s.cni.cncf.io   2022-03-04T14:45:48Z

```

해당 CRD의 일부 내용을 보연 아래와 같은 내용이 포함되어있다.
```
spec:
  conversion:
    strategy: None
  group: k8s.cni.cncf.io
  names:
    kind: NetworkAttachmentDefinition
    listKind: NetworkAttachmentDefinitionList
    plural: network-attachment-definitions
    shortNames:
    - net-attach-def
    singular: network-attachment-definition

```

kubernetes cluster에서 network-attachment-definitions의 api resources를 확인할 수 있다.

대략적으로 이 리소스을 이용하여 pod에 추가 NIC를 추가할 수 있다고 판단할 수 있겠다.
```
kubectl api-resources | grep net-attach-def
network-attachment-definitions    net-attach-def   k8s.cni.cncf.io/v1                     true         NetworkAttachmentDefinition

```

## macvlan 설정

macvlan 설정을 CR(Custom Resource)로 저장할 수 있다.


macvlan 설정 시 ```config``` 구간에 해당 랩에서 Private zone으로 명시된 IP 대역을 사용해야 한다.

'''metadata''' 밑에 ```name``` 필드는 pod에 macvlan 설정 명을 지정하여 사용할 수 있게한다.

```
cat <<EOF | kubectl create -f -
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: privatezone-macvlan-conf
spec:
  config: '{
      "cniVersion": "0.3.0",
      "type": "macvlan",
      "master": "enp0s8",
      "mode": "bridge",
      "ipam": {
        "type": "host-local",
        "subnet": "10.12.34.0/24",
        "rangeStart": "10.12.34.200",
        "rangeEnd": "10.12.34.220",
        "routes": [
          { "dst": "0.0.0.0/0" }
        ],
        "gateway": "10.12.34.254"
      }
    }'
EOF
```

